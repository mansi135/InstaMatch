{% extends 'base.html' %}

{% block title %}My Messages{% endblock %}

{% block head %}
    <style>
        .side-by-side {
            float: left;
        }
        .cl {
            clear: left;
        }
        img {
            border-radius: 50%;
        }
        .chat-box {
            border: 2px solid #dedede;
            background-color: #f1f1f1;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }

        .darker {
            border-color: #ccc;
            background-color: #ddd;
        }
        .chat-box::after {
            content: "";
            clear: both;
            display: table;
        }
        .chat-window {
          width: 300px
          height: 400px
          background-color: #eee
          border-radius: 16px 16px 0 0
          border: 2px #45f solid
          overflow-y: scroll;
      }
    </style>
{% endblock %}

{% block content %}

<!-- This is a good case for nested containers -->

<div class="row">
    <div class="col-lg-4" id="user-summary" > 
          {% for user, message in user_list %}
            <div style="padding: 10px; margin-left: 10px;">
              <div class="side-by-side">
                <img src="/{{ UPLOAD_FOLDER }}{{ user.pictures[0].picture_url }}" width="200" height="200">
              </div>
              <div class="side-by-side">
                <p> {{ user.fname }} {{ user.lname }} </p>
                <p> <a href="#" class="messages" id="history_{{ user.user_id }}" data-id="{{ user.user_id }}" data-fname="{{ user.fname }}">   
                {{ message[1][:35] }}...</a> </p>  
                <!-- slice the entire message to only 35 chars above and add ..., otherwise it wraps t next line -->
                <p><span class="time-ago"></span></p>
                <p class="stamp"> {{ message[2] }} </p>
              </div>
              <div class="cl">
              </div>
            </div>
          {% endfor %} 
    </div>

    <div class="col-lg-6 chat-window" id="chat-window" style="background-color: pink; padding-bottom: 10px; overflow-y: scroll;">
    </div>
</div>
    
{% endblock %}

{% block javascript %} 
    
    <script>
        $(document).ready(function() {

            // Pop-over method not using it any more , but was very hard to figure it out
            // $(".messages").click(function(evt){
            //         $(".messages").popover('hide');
            //         var link = $(this);
            //         console.log(link);
            //         $.get("/retrieve-messages.json", 
            //               {"uid": $(this).data("id"),
            //                "fname": $(this).data("fname")}, 
            //               function(results){
            //                    // results.data = results.data.replace("\n","<br />\n");
            //                    //we cannot use 'this' here because its lost..hence we save it in a var
            //                     link.popover({content: results.data, html: true});
            //                     link.popover('show');
            //               });
            //     });

            var link, uid, fname;

            $(".messages").click(function(evt) {
                    link = $(this);
                    to_id = $(this).data("id");
                    fname = $(this).data("fname");
                    
                    retrieveMessages();
                        
             });

            function retrieveMessages() {
                $.get("/retrieve-messages.json", { "uid": to_id, "fname": fname }, showChat);
            }

            // This should be displayed in ascending order
            function showChat(history) {
                
                $('#chat-window').empty();
                $('#chat-window').append("<h3>Chat with " + link.data('fname') + "</h3>");

                for (let i = 0; i < history.length; i += 3) {

                    if (history[i] === 'You') {
                        $('<div class="chat-box"><p style="float: right;"><b>' + history[i] + '</b> ' + history[i+1] + '</p><p class="stamp">' + history[i+2] + '</p><p style="clear: right; float: right;"><span class="time-ago"></span></p></div>').appendTo('#chat-window');
                    }
                    else {
                        $('<div class="chat-box darker"><p><b>' + history[i] + '</b> ' + history[i+1] + '</p><p class="stamp">' + history[i+2] + '</p><p><span class="time-ago"></span></p></div>').appendTo('#chat-window');
                    }                   
                    
                }

                $('.stamp').hide();
                checkTimeAgo();

                $('<footer><div class="input-group"><input type="text" class="form-control" placeholder="Message" id="message-text"><span class="input-group-btn"><button class="btn btn-primary send" type="button">Send</button></span></div></footer>').appendTo('#chat-window');

                // Attach this event listener here - it wont be attached inside document.ready
                $('.send').on('click', callBck);

                
            }

           

            function callBck(evt) {
                console.log('here');
                evt.preventDefault();
                
                let payload = {'text': $('#message-text').val(), 'to_id': to_id, 'timestamp': new Date()};
                $.post("/send-message", payload, function(response) {
                    // $('.send').hide();
                    retrieveMessages();
                });
             }


        })

    </script>
    <script src="/static/js/checkTimeAgo.js"></script>


{% endblock %}